{{ define "sqlmgr" }}// auto generated by tuk-gen
{{ $objName := .Name -}}
{{ $structName := printf "s%sSQLMgr" $objName -}}
package {{ .Package }}

import (
    "database/sql"

    "github.com/tukdesk/base/sql/db"
    "github.com/tukdesk/base/sql/types"
)

var (
    _ sql.Result
    _ db.Conn
    _ types.Id

    ins{{ $objName }}SQLMgr = &{{ $structName }}{}
)

func {{ $objName }}SQLMgr() *{{ $structName }} {
    return ins{{ $objName }}SQLMgr
}

type {{ $structName }} struct {
    obj *{{ $objName }}
}

func (*{{ $structName }}) Table() string {
    return "{{ .Table }}"
}

func (*{{ $structName }}) Engine() string {
    return "{{ .Engine }}"
}

func (this *{{ $structName }}) Conn() (*db.Conn, error) {
    conn, err := db.Get(this.Engine())
    if err != nil {
        return nil, err
    }

    return conn, nil
}

func (this *{{ $structName }}) Insert(objs ...*{{ $objName }}) (sql.Result, error) {
    if len(objs) == 0 {
        return nil, nil
    }

    conn, err := this.Conn()
    if err != nil {
        return nil, err
    }

    stmt := conn.SQL.InsertInto(this.Table()).Columns(this.obj.Fields()...)
    for _, obj := range objs {
        stmt = stmt.Values(obj.ValueAll()...)
    }

    query, err := conn.SQL.Build(stmt)
    if err != nil {
        return nil, err
    }

    return conn.Exec(query)
}

func (this *{{ $structName }}) FindOneByPrimaryKey(key {{ .PrimaryKey.Type.GoType }}) (*{{ $objName }}, error) {
    conn, err := this.Conn()
    if err != nil {
        return nil, err
    }

    res := &{{ $objName }}{}
    fields := this.obj.Fields()
    stmt := conn.SQL.Select(fields...).
        From(this.Table()).
        Where(conn.SQL.Eq("{{ .PrimaryKey.Column }}", key))

    query, err := conn.SQL.Build(stmt)
    if err != nil {
        return nil, err
    }

    row := conn.QueryRow(query)

    if err := res.ScanAll(row); err != nil {
        return nil, err
    }

    return res, nil
}

func (this *{{ $structName }}) FindByPrimaryKeys(keys []{{ .PrimaryKey.Type.GoType }}, orders ...db.Order) ([]*{{ $objName }}, error) {
    conn, err := this.Conn()
    if err != nil {
        return nil, err
    }

    res := make([]*{{ $objName }}, 0, len(keys))
    fields := this.obj.Fields()
    stmt := conn.SQL.Select(fields...).
        From(this.Table()).
        Where(conn.SQL.Eq("{{ .PrimaryKey.Column }}", keys))

    for _, order := range orders {
        if order.DESC {
            stmt = stmt.OrderDesc(order.Column)
            continue
        }

        stmt = stmt.OrderAsc(order.Column)
    }

    query, err := conn.SQL.Build(stmt)
    if err != nil {
        return nil, err
    }

    rows, err := conn.Query(query)
    if db.IsErrNoRows(err) {
        return res, nil
    }

    if err != nil {
        return nil, err
    }

    for rows.Next() {
        obj := &{{ $objName }}{}
        if err := obj.ScanAll(rows); err != nil {
            return nil, err
        }

        res = append(res, obj)
    }

    return res, nil
}
{{ end -}}
